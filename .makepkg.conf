#########################################################################
# ARCHITECTURE, COMPILE FLAGS
#########################################################################
CARCH="x86_64"
CHOST="x86_64-pc-linux-gnu"

# -march (or -mcpu) builds exclusively for an architecture
# -mtune optimizes for an architecture, but builds for whole processor family
CFLAGS="-march=native -mtune=native -O3 -mfpmath=sse -msse2 -msse3 -msse4 -mavx -mavx2 -maes \
-mprefer-vector-width=256 -mmove-max=256 -mstackrealign -mavx256-split-unaligned-load \
-mavx256-split-unaligned-store -ffast-math -fno-math-errno -fno-trapping-math -ffinite-math-only \
-fno-signed-zeros -fno-signaling-nans -fcf-protection=none -mharden-sls=none -fno-semantic-interposition \
-fipa-pta -fipa-icf -fipa-ra -fipa-pure-const -fipa-reference -fdevirtualize-speculatively \
-fdevirtualize-at-ltrans -fno-plt -fno-stack-protector -fno-exceptions -fdata-sections -ffunction-sections \
-fno-fp-int-builtin-inexact -ftree-vectorize -fvect-cost-model=unlimited -fsimd-cost-model=unlimited \
-ftree-slsr -ftree-pre -ftree-partial-pre -funroll-loops -fmerge-all-constants -fmerge-constants \
-fsplit-loops -ftree-loop-distribution -ftree-loop-vectorize -fgraphite-identity -floop-nest-optimize \
-floop-block -fwhole-program -fno-common -fsched-pressure -fsched-spec-load -fsched-stalled-insns=16 \
-fsched-stalled-insns-dep=32 -fsched-spec -fsched-spec-load-dangerous -freschedule-modulo-scheduled-loops \
-fsched-critical-path-heuristic -fsched-dep-count-heuristic -fsched-group-heuristic \
-fsched-last-insn-heuristic -fopt-info-vec-optimized -fdelete-dead-exceptions -fdelete-null-pointer-checks \
-fdse -fgcse-after-reload -fconserve-stack -fshrink-wrap -fshrink-wrap-separate -Wp,-D_FORTIFY_SOURCE=2 \
-Wformat -Werror=format-security -fstack-clash-protection"

CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"

RUSTFLAGS="-C opt-level=3 -C target-cpu=native -C link-arg=-z -C link-arg=pack-relative-relocs"

# Link Time Optimization
LTOFLAGS="-flto=auto -fuse-linker-plugin -ffat-lto-objects -flto-partition=one \
-flto-compression-level=0 -flto-odr-type-merging -fwhole-program-vtables"

#########################################################################
# EXTENSION OF MAKEPKG
#########################################################################
CFLAGS+=" ${LTOFLAGS}"
CXXFLAGS+=" ${LTOFLAGS}"
LDFLAGS="-Wl,-O3,--sort-common,--as-needed,-z,now,-z,relro,-z,pack-relative-relocs,-lgomp,--hash-style=gnu,\
--gc-sections,--icf=all,--undefined-version,--build-id=sha1,--no-add-needed,--no-copy-dt-needed-entries,\
--no-keep-memory,--reduce-memory-overheads,--threads,--strip-all,--discard-locals,--discard-all"

#########################################################################
# MAKE SPECIFIC FLAGS
#########################################################################
MAKEFLAGS="-j$(nproc) -l$(nproc) --output-sync=target --shuffle --warn-undefined-variables \
--no-builtin-rules --no-builtin-variables"
NINJAFLAGS="-j$(nproc)"

#########################################################################
# COMPRESSION DEFAULTS
#########################################################################
COMPRESSGZ=(gz)
COMPRESSBZ2=(bzip2 -c -f)
COMPRESSXZ=(xz -c -z --threads=0 -)
COMPRESSZST=(zstd -c -z -q --threads=0 -)
COMPRESSLZ=(lzip -c -f)
COMPRESSLRZ=(lrzip -q)
COMPRESSLZO=(lzop -q)
COMPRESSZ=(compress -c -f)
COMPRESSLZ4=(lz4 -q)
COMPRESSLIST=(gz bz2 xz zst lz lrz lzo z lz4)

#########################################################################
# EXTENSION DEFAULTS
#########################################################################
PKGEXT='.pkg.tar.zst'
SRCEXT='.src.tar.zst'

#########################################################################
# MEMORY MANAGEMENT
#########################################################################
export MALLOC_ARENA_MAX=$(($(nproc) * 2))
export MALLOC_MMAP_THRESHOLD_=131072
export MALLOC_TRIM_THRESHOLD_=131072
export MALLOC_TOP_PAD_=131072

#########################################################################
# BUILD ENVIRONMENT
#########################################################################
BUILDENV=(!distcc color !ccache check !sign)

#########################################################################
# GLOBAL PACKAGE OPTIONS
#########################################################################
OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge !debug lto)

#########################################################################
# KERNEL SPECIFIC FLAGS
#########################################################################
CFLAGS_KERNEL="${CFLAGS}"
CXXFLAGS_KERNEL="${CXXFLAGS}"
CFLAGS_MODULE="${CFLAGS}"
CXXFLAGS_MODULE="${CXXFLAGS}"
KBUILD_CFLAGS="${CFLAGS}"
KCFLAGS="-O3"
KCPPFLAGS="${KCFLAGS}"
